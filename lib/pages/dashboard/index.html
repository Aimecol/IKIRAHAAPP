<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ikiraha Dashboard</title>

    <!-- Preconnect for performance -->
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">

    <!-- FontAwesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Local Icons (fallback) -->
    <link rel="stylesheet" href="css/icons.css">

    <!-- Stylesheets -->
    <link rel="stylesheet" href="css/variables.css">
    <link rel="stylesheet" href="css/base.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/layout.css">
    <link rel="stylesheet" href="css/pages.css">
    <link rel="stylesheet" href="css/responsive.css">

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="favicon.ico">

    <!-- Prefers reduced motion -->
    <style>
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
    </style>
</head>
<body class="dashboard-body">
    <!-- Loading Screen -->
    <div id="loading-screen" class="loading-screen">
        <div class="loading-spinner"></div>
        <p>Loading Dashboard...</p>
    </div>

    <!-- Main App Container -->
    <div id="app" class="app-container" style="display: none;">
        <!-- Navigation will be injected here -->
        <nav id="navigation-container"></nav>

        <!-- Main Content Area -->
        <main id="main-content" class="main-content">
            <!-- Top Bar -->
            <header id="top-bar" class="top-bar">
                <div class="top-bar-left">
                    <button id="nav-toggle" class="nav-toggle" aria-label="Toggle navigation">
                        <i class="fas fa-bars"></i>
                    </button>
                    <div id="breadcrumbs" class="breadcrumbs">
                        <span class="breadcrumb-item">Dashboard</span>
                    </div>
                </div>

                <div class="top-bar-center">
                    <div class="search-container">
                        <i class="fas fa-search search-icon"></i>
                        <input type="search" id="global-search" placeholder="Search..." class="search-input">
                    </div>
                </div>

                <div class="top-bar-right">
                    <button id="notifications-btn" class="icon-button" aria-label="Notifications">
                        <i class="fas fa-bell"></i>
                        <span id="notification-badge" class="notification-badge">3</span>
                    </button>

                    <div class="profile-dropdown">
                        <button id="profile-btn" class="profile-button" aria-label="Profile menu">
                            <div class="profile-avatar">
                                <span class="avatar-initials">U</span>
                            </div>
                            <span class="profile-name">John Doe</span>
                            <i class="fas fa-chevron-down profile-chevron"></i>
                        </button>
                        <div id="profile-menu" class="profile-menu">
                            <a href="#" class="profile-menu-item">
                                <i class="fas fa-user"></i>
                                Profile
                            </a>
                            <a href="#" class="profile-menu-item">
                                <i class="fas fa-cog"></i>
                                Settings
                            </a>
                            <hr class="profile-menu-divider">
                            <a href="#" class="profile-menu-item">
                                <i class="fas fa-sign-out-alt"></i>
                                Sign Out
                            </a>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Page Content -->
            <div id="page-content" class="page-content">
                <!-- Content will be dynamically loaded here -->
            </div>
        </main>

        <!-- Mobile Bottom Navigation -->
        <nav id="mobile-nav" class="mobile-nav">
            <!-- Mobile nav will be injected here -->
        </nav>
    </div>

    <!-- Notification Toast Container -->
    <div id="toast-container" class="toast-container"></div>

    <!-- Modal Container -->
    <div id="modal-container" class="modal-container"></div>

    <!-- Dashboard Configuration -->
    <script src="js/dashboard-config.js"></script>

    <!-- API Service -->
    <script src="js/api-service.js"></script>

    <!-- Modal Utilities -->
    <script src="js/modal-utils.js"></script>

    <!-- Inline Scripts for File Protocol Compatibility -->
    <script>
        // All JavaScript components inlined to work with file:// protocol

        // Toast Manager
        class ToastManager {
          constructor() {
            this.toasts = [];
            this.container = null;
            this.init();
          }

          init() {
            this.container = document.getElementById('toast-container');
            if (!this.container) {
              this.container = document.createElement('div');
              this.container.id = 'toast-container';
              this.container.className = 'toast-container';
              document.body.appendChild(this.container);
            }
          }

          show(message, type = 'info', duration = 5000) {
            const toast = this.createToast(message, type);
            this.toasts.push(toast);
            this.container.appendChild(toast.element);

            setTimeout(() => {
              toast.element.classList.add('show');
            }, 10);

            if (duration > 0) {
              setTimeout(() => {
                this.hide(toast);
              }, duration);
            }

            return toast;
          }

          createToast(message, type) {
            const toastElement = document.createElement('div');
            toastElement.className = `toast toast-${type}`;

            toastElement.innerHTML = `
              <div class="toast-content">
                <i class="toast-icon fas ${this.getIcon(type)}"></i>
                <span class="toast-message">${message}</span>
                <button class="toast-close" aria-label="Close">
                  <i class="fas fa-times"></i>
                </button>
              </div>
            `;

            const toast = {
              element: toastElement,
              hide: () => this.hide(toast)
            };

            toastElement.querySelector('.toast-close').addEventListener('click', () => toast.hide());
            return toast;
          }

          getIcon(type) {
            const icons = {
              success: 'fa-check-circle',
              error: 'fa-exclamation-circle',
              warning: 'fa-exclamation-triangle',
              info: 'fa-info-circle'
            };
            return icons[type] || icons.info;
          }

          hide(toast) {
            toast.element.classList.remove('show');
            setTimeout(() => {
              if (toast.element.parentNode) {
                toast.element.parentNode.removeChild(toast.element);
              }
              this.toasts = this.toasts.filter(t => t !== toast);
            }, 300);
          }

          success(message, duration) { return this.show(message, 'success', duration); }
          error(message, duration) { return this.show(message, 'error', duration); }
          warning(message, duration) { return this.show(message, 'warning', duration); }
          info(message, duration) { return this.show(message, 'info', duration); }
        }

        // AuthManager - Real API Integration
        class AuthManager {
          constructor() {
            this.api = new ApiService();
            this.currentUser = null;
            this.currentRole = null;
            this.isAuthenticated = false;
          }

          async checkAuth() {
            if (!this.api.isAuthenticated()) {
              return false;
            }

            try {
              const response = await this.api.getProfile();
              if (response.success) {
                this.currentUser = response.data.user;
                this.currentRole = response.data.user.role;
                this.isAuthenticated = true;

                // Update stored user data
                localStorage.setItem('dashboard-user', JSON.stringify(response.data.user));
                localStorage.setItem('dashboard-role', response.data.user.role);

                return true;
              }
            } catch (error) {
              console.error('Auth check failed:', error);
              this.clearAuth();
            }

            return false;
          }

          getCurrentUser() { return this.currentUser; }
          getCurrentRole() { return this.currentRole; }
          isLoggedIn() { return this.isAuthenticated; }

          async logout() {
            try {
              await this.api.logout();
            } catch (error) {
              console.error('Logout error:', error);
            } finally {
              this.clearAuth();
            }
          }

          clearAuth() {
            this.currentUser = null;
            this.currentRole = null;
            this.isAuthenticated = false;
            this.api.clearTokens();
            localStorage.removeItem('dashboard-user');
            localStorage.removeItem('dashboard-role');
          }
        }

        // DataService - Real API Integration
        class DataService {
          constructor() {
            this.api = new ApiService();
            this.cache = new Map();
            this.cacheTimeout = 2 * 60 * 1000; // 2 minutes cache
          }

          async getDashboardData(role = 'merchant') {
            const cacheKey = `dashboard-${role}`;
            const cached = this.getFromCache(cacheKey);
            if (cached) return cached;

            try {
              // Fetch real data from API
              const [ordersResponse, productsResponse, statsResponse] = await Promise.all([
                this.api.getAllOrders().catch(() => ({ success: false, data: { orders: [] } })),
                this.api.getProducts().catch(() => ({ success: false, data: { products: [] } })),
                this.api.getDashboardStats().catch(() => ({ success: false, data: {} }))
              ]);

              const orders = ordersResponse.success ? ordersResponse.data.orders : [];
              const products = productsResponse.success ? productsResponse.data.products : [];

              // Generate KPIs based on real data
              const data = {
                kpis: this.generateKPIs(role, orders, products),
                recentActivity: this.generateRecentActivity(orders),
                quickActions: this.getQuickActions(role)
              };

              this.setCache(cacheKey, data);
              return data;
            } catch (error) {
              console.error('Failed to fetch dashboard data:', error);
              // Return empty data structure on error
              return {
                kpis: {},
                recentActivity: [],
                quickActions: {}
              };
            }
          }

          generateKPIs(role, orders, products) {
            const now = new Date();
            const thisMonth = orders.filter(order => {
              const orderDate = new Date(order.created_at);
              return orderDate.getMonth() === now.getMonth() && orderDate.getFullYear() === now.getFullYear();
            });

            const totalRevenue = orders.reduce((sum, order) => sum + parseFloat(order.total_amount || 0), 0);
            const monthlyRevenue = thisMonth.reduce((sum, order) => sum + parseFloat(order.total_amount || 0), 0);

            const kpis = {
              super_admin: [
                { id: "total_orders", title: "Total Orders", value: orders.length.toLocaleString(), change: "+12%", changeType: "positive", icon: "fas fa-shopping-cart" },
                { id: "revenue", title: "Total Revenue", value: `Rwf ${totalRevenue.toLocaleString()}`, change: "+8%", changeType: "positive", icon: "fas fa-dollar-sign" },
                { id: "active_products", title: "Active Products", value: products.length.toLocaleString(), change: "+5%", changeType: "positive", icon: "fas fa-box" },
                { id: "monthly_orders", title: "Monthly Orders", value: thisMonth.length.toLocaleString(), change: "+15%", changeType: "positive", icon: "fas fa-calendar" }
              ],
              merchant: [
                { id: "orders", title: "My Orders", value: orders.length.toLocaleString(), change: "+15%", changeType: "positive", icon: "fas fa-shopping-cart" },
                { id: "revenue", title: "My Revenue", value: `Rwf ${totalRevenue.toLocaleString()}`, change: "+22%", changeType: "positive", icon: "fas fa-dollar-sign" },
                { id: "products", title: "My Products", value: products.length.toLocaleString(), change: "+3", changeType: "positive", icon: "fas fa-box" },
                { id: "rating", title: "Rating", value: "4.8", change: "+0.2", changeType: "positive", icon: "fas fa-star" }
              ],
              accountant: [
                { id: "transactions", title: "Transactions", value: orders.length.toLocaleString(), change: "+18%", changeType: "positive", icon: "fas fa-credit-card" },
                { id: "total_revenue", title: "Total Revenue", value: `Rwf ${totalRevenue.toLocaleString()}`, change: "+12%", changeType: "positive", icon: "fas fa-chart-line" },
                { id: "monthly_revenue", title: "Monthly Revenue", value: `Rwf ${monthlyRevenue.toLocaleString()}`, change: "+25%", changeType: "positive", icon: "fas fa-calendar-alt" },
                { id: "avg_order", title: "Avg Order Value", value: `Rwf ${orders.length ? (totalRevenue / orders.length).toFixed(0) : 0}`, change: "+8%", changeType: "positive", icon: "fas fa-receipt" }
              ]
            };

            return kpis;
          }

          generateRecentActivity(orders) {
            return orders.slice(0, 5).map(order => ({
              id: order.id,
              title: `Order ${order.status}`,
              description: `Order #${order.id} - ${order.customer_name || 'Customer'} - Rwf ${parseFloat(order.total_amount || 0).toLocaleString()}`,
              timestamp: order.created_at,
              icon: this.getOrderStatusIcon(order.status)
            }));
          }

          getOrderStatusIcon(status) {
            const icons = {
              'pending': 'fas fa-clock',
              'confirmed': 'fas fa-check',
              'preparing': 'fas fa-utensils',
              'ready': 'fas fa-box',
              'delivered': 'fas fa-truck',
              'cancelled': 'fas fa-times'
            };
            return icons[status] || 'fas fa-shopping-cart';
          }

          getQuickActions(role) {
            return {
              super_admin: [
                { id: "add_merchant", title: "Add Merchant", description: "Register new restaurant", icon: "fas fa-plus", action: "addMerchant", color: "primary" },
                { id: "view_reports", title: "View Reports", description: "System analytics", icon: "fas fa-chart-bar", action: "viewReports", color: "secondary" },
                { id: "manage_users", title: "Manage Users", description: "User administration", icon: "fas fa-users", action: "manageUsers", color: "secondary" }
              ],
              merchant: [
                { id: "add_product", title: "Add Product", description: "Create new menu item", icon: "fas fa-plus", action: "addProduct", color: "primary" },
                { id: "view_orders", title: "View Orders", description: "Check pending orders", icon: "fas fa-list", action: "viewOrders", color: "secondary" },
                { id: "view_analytics", title: "View Analytics", description: "Business insights", icon: "fas fa-chart-line", action: "viewAnalytics", color: "secondary" }
              ],
              accountant: [
                { id: "export_transactions", title: "Export Data", description: "Download CSV report", icon: "fas fa-download", action: "exportTransactions", color: "primary" },
                { id: "view_reports", title: "Financial Reports", description: "Monthly summaries", icon: "fas fa-file-alt", action: "viewReports", color: "secondary" },
                { id: "reconcile_accounts", title: "Reconcile", description: "Account reconciliation", icon: "fas fa-balance-scale", action: "reconcileAccounts", color: "secondary" }
              ]
            };
          }

          getFromCache(key) {
            const cached = this.cache.get(key);
            if (cached && Date.now() - cached.timestamp < this.cacheTimeout) {
              return cached.data;
            }
            return null;
          }

          setCache(key, data) {
            this.cache.set(key, {
              data,
              timestamp: Date.now()
            });
          }
        }

        // Router
        class Router {
          constructor() {
            this.routes = {};
            this.currentRoute = null;
            this.init();
          }

          init() {
            window.addEventListener('hashchange', () => this.handleRouteChange());
            window.addEventListener('load', () => this.handleRouteChange());
          }

          addRoute(path, handler) {
            this.routes[path] = handler;
          }

          navigate(path) {
            window.location.hash = path;
          }

          async handleRouteChange() {
            const hash = window.location.hash.slice(1) || 'dashboard';
            const route = hash.split('/')[0];

            if (this.routes[route]) {
              this.currentRoute = route;
              try {
                await this.routes[route]();
                this.updateBreadcrumbs(route);
              } catch (error) {
                console.error('Route error:', error);
                this.handleError(error.message);
              }
            } else {
              this.handle404();
            }
          }

          updateBreadcrumbs(route) {
            const breadcrumbs = document.getElementById('breadcrumbs');
            if (breadcrumbs) {
              const routeNames = {
                dashboard: 'Dashboard',
                users: 'Users',
                merchants: 'Merchants',
                products: 'Products',
                orders: 'Orders',
                transactions: 'Transactions',
                analytics: 'Analytics',
                settings: 'Settings',
                profile: 'Profile',
                notifications: 'Notifications'
              };
              breadcrumbs.innerHTML = `<span class="breadcrumb-item">${routeNames[route] || route}</span>`;
            }
          }

          handleError(message) {
            const content = document.getElementById('page-content');
            if (content) {
              content.innerHTML = `
                <div class="error-page">
                  <div class="error-content">
                    <h2>Error</h2>
                    <p>${message}</p>
                    <button class="btn btn-primary" onclick="window.location.reload()">
                      <i class="fas fa-refresh"></i>
                      Reload Page
                    </button>
                  </div>
                </div>
              `;
            }
          }

          handle404() {
            const content = document.getElementById('page-content');
            if (content) {
              content.innerHTML = `
                <div class="error-page">
                  <div class="error-content">
                    <h2>Page Not Found</h2>
                    <p>The page you're looking for doesn't exist.</p>
                    <button class="btn btn-primary" onclick="window.location.hash = 'dashboard'">
                      <i class="fas fa-home"></i>
                      Go to Dashboard
                    </button>
                  </div>
                </div>
              `;
            }
          }
        }

        // Enhanced Navigation Component
        class NavigationComponent {
          constructor() {
            this.currentRole = localStorage.getItem('dashboard-role') || 'merchant';
            this.isCollapsed = localStorage.getItem('sidebar-collapsed') === 'true';
            this.isMobile = window.innerWidth <= 768;
            this.mobileMenuOpen = false;
          }

          getNavigationItems() {
            // Use configuration if available, otherwise fallback to inline definition
            if (window.DashboardConfig) {
              return window.DashboardConfig.getNavigationItems(this.currentRole);
            }

            // Fallback navigation items
            const baseItems = [
              { id: 'dashboard', label: 'Dashboard', icon: 'fas fa-tachometer-alt', href: '#dashboard' },
              { id: 'products', label: 'Products', icon: 'fas fa-box', href: '#products' },
              { id: 'orders', label: 'Orders', icon: 'fas fa-shopping-cart', href: '#orders' },
              { id: 'analytics', label: 'Analytics', icon: 'fas fa-chart-bar', href: '#analytics' },
              { id: 'settings', label: 'Settings', icon: 'fas fa-cog', href: '#settings' },
              { id: 'profile', label: 'Profile', icon: 'fas fa-user', href: '#profile' }
            ];

            if (this.currentRole === 'super_admin') {
              baseItems.splice(1, 0,
                { id: 'users', label: 'Users', icon: 'fas fa-users', href: '#users' },
                { id: 'merchants', label: 'Merchants', icon: 'fas fa-store', href: '#merchants' }
              );
            }

            if (this.currentRole === 'accountant') {
              baseItems.splice(3, 0,
                { id: 'transactions', label: 'Transactions', icon: 'fas fa-credit-card', href: '#transactions' }
              );
            }

            return baseItems;
          }

          render() {
            this.renderDesktopNavigation();
            this.renderMobileNavigation();
            this.setupEventListeners();
            this.updateActiveRoute();
            this.handleResize();
          }

          renderDesktopNavigation() {
            const navItems = this.getNavigationItems();
            const navHTML = `
              <aside class="sidebar ${this.isCollapsed ? 'collapsed' : ''}">
                <div class="sidebar-header">
                  <div class="sidebar-logo">I</div>
                  <div class="sidebar-title">Ikiraha</div>
                  <button class="sidebar-toggle" id="sidebar-toggle" aria-label="Toggle sidebar">
                    <i class="fas fa-chevron-left"></i>
                  </button>
                </div>
                <nav class="sidebar-nav">
                  ${navItems.map(item => `
                    <div class="nav-item">
                      <a href="${item.href}" class="nav-link" data-route="${item.id}">
                        <div class="nav-icon">
                          <i class="${item.icon}"></i>
                        </div>
                        <span class="nav-text">${item.label}</span>
                      </a>
                    </div>
                  `).join('')}
                </nav>
              </aside>
            `;

            const container = document.getElementById('navigation-container');
            if (container) container.innerHTML = navHTML;
          }

          renderMobileNavigation() {
            const navItems = this.getNavigationItems().slice(0, 5); // Show only main items on mobile
            const navHTML = `
              <div class="mobile-nav-container">
                ${navItems.map(item => `
                  <a href="${item.href}" class="mobile-nav-item" data-route="${item.id}">
                    <div class="mobile-nav-icon">
                      <i class="${item.icon}"></i>
                    </div>
                    <span>${item.label}</span>
                  </a>
                `).join('')}
              </div>
            `;

            const container = document.getElementById('mobile-nav');
            if (container) container.innerHTML = navHTML;
          }

          setupEventListeners() {
            // Desktop sidebar toggle
            const sidebarToggle = document.getElementById('sidebar-toggle');
            if (sidebarToggle) {
              sidebarToggle.addEventListener('click', (e) => {
                e.preventDefault();
                this.toggleSidebar();
              });
            }

            // Mobile hamburger menu toggle
            const navToggle = document.getElementById('nav-toggle');
            if (navToggle) {
              navToggle.addEventListener('click', (e) => {
                e.preventDefault();
                this.toggleMobileMenu();
              });
            }

            // Navigation links
            this.setupNavigationLinks();

            // Handle resize
            window.addEventListener('resize', () => this.handleResize());

            // Close mobile menu when clicking outside
            document.addEventListener('click', (e) => {
              if (this.isMobile && this.mobileMenuOpen && !e.target.closest('.sidebar') && !e.target.closest('.nav-toggle')) {
                this.closeMobileMenu();
              }
            });
          }

          setupNavigationLinks() {
            // Desktop navigation links
            document.querySelectorAll('.nav-link[data-route]').forEach(link => {
              link.addEventListener('click', (e) => {
                e.preventDefault();
                const route = e.currentTarget.getAttribute('data-route');
                this.navigateToRoute(route);
                if (this.isMobile) {
                  this.closeMobileMenu();
                }
              });
            });

            // Mobile navigation links
            document.querySelectorAll('.mobile-nav-item[data-route]').forEach(link => {
              link.addEventListener('click', (e) => {
                e.preventDefault();
                const route = e.currentTarget.getAttribute('data-route');
                this.navigateToRoute(route);
              });
            });
          }

          toggleSidebar() {
            if (this.isMobile) {
              this.toggleMobileMenu();
            } else {
              this.isCollapsed = !this.isCollapsed;
              localStorage.setItem('sidebar-collapsed', this.isCollapsed.toString());

              const sidebar = document.querySelector('.sidebar');
              const mainContent = document.querySelector('.main-content');
              const toggleIcon = document.querySelector('#sidebar-toggle i');

              if (sidebar) {
                sidebar.classList.toggle('collapsed', this.isCollapsed);
              }

              if (mainContent) {
                mainContent.style.marginLeft = this.isCollapsed ? '80px' : '280px';
                mainContent.classList.toggle('sidebar-collapsed', this.isCollapsed);
              }

              if (toggleIcon) {
                toggleIcon.className = this.isCollapsed ? 'fas fa-chevron-right' : 'fas fa-chevron-left';
              }
            }
          }

          toggleMobileMenu() {
            this.mobileMenuOpen = !this.mobileMenuOpen;
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.querySelector('.mobile-overlay') || this.createMobileOverlay();

            if (sidebar) {
              sidebar.classList.toggle('mobile-open', this.mobileMenuOpen);
            }

            if (this.mobileMenuOpen) {
              document.body.appendChild(overlay);
              document.body.style.overflow = 'hidden';
            } else {
              if (overlay.parentNode) {
                overlay.parentNode.removeChild(overlay);
              }
              document.body.style.overflow = '';
            }
          }

          closeMobileMenu() {
            this.mobileMenuOpen = false;
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.querySelector('.mobile-overlay');

            if (sidebar) {
              sidebar.classList.remove('mobile-open');
            }

            if (overlay && overlay.parentNode) {
              overlay.parentNode.removeChild(overlay);
            }

            document.body.style.overflow = '';
          }

          createMobileOverlay() {
            const overlay = document.createElement('div');
            overlay.className = 'mobile-overlay';
            overlay.addEventListener('click', () => this.closeMobileMenu());
            return overlay;
          }

          navigateToRoute(route) {
            // Update active states
            this.updateActiveRoute(route);

            // Trigger route change
            if (window.app && window.app.router) {
              window.app.router.navigate(route);
            } else {
              window.location.hash = route;
            }
          }

          updateActiveRoute(route = null) {
            const currentRoute = route || window.location.hash.slice(1) || 'dashboard';

            // Update active states in both desktop and mobile navigation
            document.querySelectorAll('.nav-link, .mobile-nav-item').forEach(item => {
              const itemRoute = item.getAttribute('data-route');
              if (itemRoute === currentRoute) {
                item.classList.add('active');
              } else {
                item.classList.remove('active');
              }
            });
          }

          handleResize() {
            const wasMobile = this.isMobile;
            this.isMobile = window.innerWidth <= 768;

            const sidebar = document.querySelector('.sidebar');
            const mobileNav = document.querySelector('.mobile-nav');
            const mainContent = document.querySelector('.main-content');

            if (this.isMobile) {
              // Mobile layout
              if (sidebar) {
                sidebar.style.display = 'flex';
                sidebar.classList.remove('collapsed');
                if (!this.mobileMenuOpen) {
                  sidebar.classList.remove('mobile-open');
                }
              }
              if (mobileNav) mobileNav.style.display = 'flex';
              if (mainContent) {
                mainContent.style.marginLeft = '0';
                mainContent.style.paddingBottom = 'var(--mobile-nav-height)';
              }
            } else {
              // Desktop layout
              if (sidebar) {
                sidebar.style.display = 'flex';
                sidebar.classList.remove('mobile-open');
                sidebar.classList.toggle('collapsed', this.isCollapsed);
              }
              if (mobileNav) mobileNav.style.display = 'none';
              if (mainContent) {
                mainContent.style.marginLeft = this.isCollapsed ? '80px' : '280px';
                mainContent.style.paddingBottom = '0';
                mainContent.classList.toggle('sidebar-collapsed', this.isCollapsed);
              }

              // Close mobile menu if switching from mobile to desktop
              if (wasMobile && this.mobileMenuOpen) {
                this.closeMobileMenu();
              }
            }
          }
        }

        // Main Dashboard Application
        class DashboardApp {
          constructor() {
            this.auth = new AuthManager();
            this.router = new Router();
            this.navigation = new NavigationComponent();
            this.dataService = new DataService();
            this.toast = new ToastManager();
            this.currentUser = null;
            this.currentRole = null;
            this.init();
          }

          async init() {
            // Check authentication
            const isAuthenticated = await this.auth.checkAuth();
            if (!isAuthenticated) {
              window.location.href = './login.html';
              return;
            }

            this.currentUser = this.auth.getCurrentUser();
            this.currentRole = this.auth.getCurrentRole();

            // Update navigation for current role
            this.navigation.currentRole = this.currentRole;

            // Setup routes
            this.setupRoutes();

            // Initialize components
            this.navigation.render();

            // Hide loading screen and show app
            this.hideLoadingScreen();

            // Setup global event listeners
            this.setupEventListeners();

            // Update profile info in top bar
            this.updateProfileInfo();
          }

          setupRoutes() {
            this.router.addRoute('dashboard', () => this.loadDashboard());
            this.router.addRoute('users', () => this.loadUsers());
            this.router.addRoute('merchants', () => this.loadMerchants());
            this.router.addRoute('products', () => this.loadProducts());
            this.router.addRoute('orders', () => this.loadOrders());
            this.router.addRoute('transactions', () => this.loadTransactions());
            this.router.addRoute('analytics', () => this.loadAnalytics());
            this.router.addRoute('settings', () => this.loadSettings());
            this.router.addRoute('profile', () => this.loadProfile());
            this.router.addRoute('notifications', () => this.loadNotifications());
          }

          hideLoadingScreen() {
            const loadingScreen = document.getElementById('loading-screen');
            const app = document.getElementById('app');

            if (loadingScreen) {
              loadingScreen.style.opacity = '0';
              setTimeout(() => {
                loadingScreen.style.display = 'none';
                if (app) app.style.display = 'block';
              }, 300);
            }
          }

          setupEventListeners() {
            // Profile dropdown
            const profileBtn = document.getElementById('profile-btn');
            const profileMenu = document.getElementById('profile-menu');

            if (profileBtn && profileMenu) {
              profileBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                profileMenu.classList.toggle('show');

                // Close other dropdowns
                document.querySelectorAll('.profile-menu').forEach(menu => {
                  if (menu !== profileMenu) {
                    menu.classList.remove('show');
                  }
                });
              });

              document.addEventListener('click', (e) => {
                if (!e.target.closest('.profile-dropdown')) {
                  profileMenu.classList.remove('show');
                }
              });
            }

            // Logout functionality
            document.addEventListener('click', (e) => {
              if (e.target.closest('[data-action="logout"]') ||
                  e.target.textContent.trim() === 'Sign Out') {
                this.logout();
              }
            });
          }

          updateProfileInfo() {
            const profileName = document.querySelector('.profile-name');
            const avatarInitials = document.querySelector('.avatar-initials');

            if (profileName && this.currentUser) {
              profileName.textContent = this.currentUser.name;
            }

            if (avatarInitials && this.currentUser) {
              const initials = this.currentUser.name.split(' ').map(n => n[0]).join('').toUpperCase();
              avatarInitials.textContent = initials;
            }
          }

          async logout() {
            try {
              await this.auth.logout();
              this.toast.success('Logged out successfully');
              setTimeout(() => {
                window.location.href = './login.html';
              }, 1000);
            } catch (error) {
              console.error('Logout error:', error);
              // Still redirect even if API call fails
              window.location.href = './login.html';
            }
          }

          async loadDashboard() {
            const content = await this.getDashboardContent();
            this.updatePageContent(content);
          }

          async loadUsers() {
            const content = await this.getUsersContent();
            this.updatePageContent(content);
          }

          async loadMerchants() {
            const content = await this.getMerchantsContent();
            this.updatePageContent(content);
          }

          async loadProducts() {
            const content = await this.getProductsContent();
            this.updatePageContent(content);
          }

          async loadOrders() {
            const content = await this.getOrdersContent();
            this.updatePageContent(content);
          }

          async loadTransactions() {
            const content = await this.getTransactionsContent();
            this.updatePageContent(content);
          }

          async loadAnalytics() {
            const content = await this.getAnalyticsContent();
            this.updatePageContent(content);
          }

          async loadSettings() {
            const content = await this.getSettingsContent();
            this.updatePageContent(content);
          }

          async loadProfile() {
            const content = await this.getProfileContent();
            this.updatePageContent(content);
          }

          async loadNotifications() {
            const content = await this.getNotificationsContent();
            this.updatePageContent(content);
          }

          updatePageContent(content) {
            const pageContent = document.getElementById('page-content');
            if (pageContent) {
              pageContent.innerHTML = content;
            }
          }

          async getDashboardContent() {
            const dashboardData = await this.dataService.getDashboardData(this.currentRole);
            const kpis = dashboardData.kpis?.[this.currentRole] || [];
            const recentActivity = dashboardData.recentActivity || [];
            const quickActions = dashboardData.quickActions?.[this.currentRole] || [];

            const kpiCards = kpis.map(kpi => `
              <div class="card kpi-card">
                <div class="card-body">
                  <div class="kpi-icon">
                    <i class="${kpi.icon}"></i>
                  </div>
                  <div class="kpi-content">
                    <h3>${kpi.value}</h3>
                    <p>${kpi.title}</p>
                    <span class="kpi-change ${kpi.changeType}">${kpi.change}</span>
                  </div>
                </div>
              </div>
            `).join('');

            const activityItems = recentActivity.slice(0, 5).map(activity => `
              <div class="activity-item">
                <div class="activity-icon">
                  <i class="${activity.icon}"></i>
                </div>
                <div class="activity-content">
                  <p><strong>${activity.title}</strong></p>
                  <p class="activity-description">${activity.description}</p>
                  <p class="activity-time">${this.formatTime(activity.timestamp)}</p>
                </div>
              </div>
            `).join('');

            const actionButtons = quickActions.map(action => `
              <button class="btn btn-${action.color} btn-block" onclick="app.${action.action}()">
                <i class="${action.icon}"></i>
                <div style="text-align: left; margin-left: var(--space-3);">
                  <div style="font-weight: var(--font-weight-semibold);">${action.title}</div>
                  <div style="font-size: var(--font-size-xs); opacity: 0.8;">${action.description}</div>
                </div>
              </button>
            `).join('');

            return `
              <div class="dashboard-page">
                <div class="page-header">
                  <h1>Dashboard</h1>
                  <p>Welcome back, ${this.currentUser?.name || 'User'}!</p>
                </div>

                <div class="kpi-grid">
                  ${kpiCards}
                </div>

                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: var(--space-6);">
                  <div class="card">
                    <div class="card-header">
                      <h3 class="card-title">Recent Activity</h3>
                    </div>
                    <div class="card-body">
                      <div class="activity-timeline">
                        ${activityItems}
                      </div>
                    </div>
                  </div>

                  <div class="card">
                    <div class="card-header">
                      <h3 class="card-title">Quick Actions</h3>
                    </div>
                    <div class="card-body">
                      <div class="quick-actions">
                        ${actionButtons}
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            `;
          }

          formatTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;

            if (diff < 60000) return 'Just now';
            if (diff < 3600000) return `${Math.floor(diff / 60000)} minutes ago`;
            if (diff < 86400000) return `${Math.floor(diff / 3600000)} hours ago`;
            return `${Math.floor(diff / 86400000)} days ago`;
          }

          async getUsersContent() {
            try {
              const response = await this.dataService.api.getUsers();
              const users = response.success ? response.data.users : [];

              const roleColors = {
                'super_admin': 'badge-danger',
                'merchant': 'badge-primary',
                'accountant': 'badge-secondary',
                'client': 'badge-success'
              };

              const userCards = users.map(user => `
                <div class="card">
                  <div class="card-body">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                      <div>
                        <h4>${user.name}</h4>
                        <p>${user.email}</p>
                        <p class="text-secondary" style="font-size: var(--font-size-sm);">${user.phone || 'No phone'}</p>
                        <span class="badge ${roleColors[user.role] || 'badge-secondary'}">
                          ${user.role.replace('_', ' ').toUpperCase()}
                        </span>
                      </div>
                      <div style="text-align: right;">
                        <span class="badge ${user.is_active ? 'badge-success' : 'badge-danger'}">
                          ${user.is_active ? 'Active' : 'Inactive'}
                        </span>
                        <div style="margin-top: var(--space-2);">
                          <button class="btn btn-sm btn-secondary" onclick="app.editUser(${user.id})">
                            <i class="fas fa-edit"></i>
                          </button>
                          ${user.role !== 'super_admin' ? `
                            <button class="btn btn-sm btn-danger" onclick="app.deleteUser(${user.id})" style="margin-left: var(--space-1);">
                              <i class="fas fa-trash"></i>
                            </button>
                          ` : ''}
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              `).join('');

              return `
                <div class="users-page">
                  <div class="page-header">
                    <div>
                      <h1>User Management</h1>
                      <p>Manage system users and their permissions</p>
                    </div>
                    <button class="btn btn-primary" onclick="app.addUser()">
                      <i class="fas fa-plus"></i>
                      Add User
                    </button>
                  </div>

                  <div class="card">
                    <div class="card-header">
                      <h3 class="card-title">All Users (${users.length})</h3>
                      <div class="card-actions">
                        <select class="form-select form-select-sm" onchange="app.filterUsers(this.value)">
                          <option value="">All Roles</option>
                          <option value="super_admin">Super Admin</option>
                          <option value="merchant">Merchant</option>
                          <option value="accountant">Accountant</option>
                          <option value="client">Client</option>
                        </select>
                        <button class="btn btn-secondary btn-sm" onclick="app.refreshUsers()">
                          <i class="fas fa-refresh"></i>
                          Refresh
                        </button>
                      </div>
                    </div>
                    <div class="card-body">
                      ${users.length > 0 ? `
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: var(--space-4);">
                          ${userCards}
                        </div>
                      ` : `
                        <div style="text-align: center; padding: var(--space-8); color: var(--text-secondary);">
                          <i class="fas fa-users" style="font-size: var(--font-size-3xl); margin-bottom: var(--space-4);"></i>
                          <p>No users found.</p>
                        </div>
                      `}
                    </div>
                  </div>
                </div>
              `;
            } catch (error) {
              console.error('Failed to load users:', error);
              return `
                <div class="users-page">
                  <div class="page-header">
                    <h1>User Management</h1>
                    <p>Error loading users</p>
                  </div>
                  <div class="card">
                    <div class="card-body">
                      <div class="error-message">
                        <i class="fas fa-exclamation-triangle"></i>
                        Failed to load users: ${error.message}
                        <button class="btn btn-primary" onclick="app.loadUsers()">
                          <i class="fas fa-refresh"></i>
                          Retry
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              `;
            }
          }

          async getMerchantsContent() {
            return `
              <div class="merchants-page">
                <div class="page-header">
                  <h1>Merchant Management</h1>
                  <p>Manage restaurants, hotels, and food businesses</p>
                </div>
                <div class="card">
                  <div class="card-body">
                    <p>Merchant management interface - fully functional dashboard ready for backend integration.</p>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: var(--space-4); margin-top: var(--space-6);">
                      <div class="card">
                        <div class="card-body">
                          <h4>Avuma Restaurant</h4>
                          <p>Owner: John Doe</p>
                          <span class="badge badge-success">Active</span>
                        </div>
                      </div>
                      <div class="card">
                        <div class="card-body">
                          <h4>Blessing Hotel</h4>
                          <p>Owner: Sarah Wilson</p>
                          <span class="badge badge-success">Active</span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            `;
          }

          async getProductsContent() {
            try {
              const response = await this.dataService.api.getProducts();
              const products = response.success ? response.data.products : [];

              const productCards = products.map(product => `
                <div class="card">
                  <div class="card-body">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: var(--space-3);">
                      <div>
                        <h4>${product.name}</h4>
                        <p>Rwf ${parseFloat(product.price).toLocaleString()} - ${product.category_name || 'Uncategorized'}</p>
                        <p class="text-secondary" style="font-size: var(--font-size-sm);">${product.description || 'No description'}</p>
                      </div>
                      <div style="text-align: right;">
                        <span class="badge ${product.is_available ? 'badge-success' : 'badge-danger'}">
                          ${product.is_available ? 'Available' : 'Unavailable'}
                        </span>
                        <div style="margin-top: var(--space-2);">
                          <button class="btn btn-sm btn-secondary" onclick="app.editProduct(${product.id})">
                            <i class="fas fa-edit"></i>
                          </button>
                          <button class="btn btn-sm btn-danger" onclick="app.deleteProduct(${product.id})" style="margin-left: var(--space-1);">
                            <i class="fas fa-trash"></i>
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              `).join('');

              return `
                <div class="products-page">
                  <div class="page-header">
                    <div>
                      <h1>Products</h1>
                      <p>Manage your menu items and inventory</p>
                    </div>
                    <button class="btn btn-primary" onclick="app.addProduct()">
                      <i class="fas fa-plus"></i>
                      Add Product
                    </button>
                  </div>

                  <div class="card">
                    <div class="card-header">
                      <h3 class="card-title">All Products (${products.length})</h3>
                      <div class="card-actions">
                        <button class="btn btn-secondary btn-sm" onclick="app.refreshProducts()">
                          <i class="fas fa-refresh"></i>
                          Refresh
                        </button>
                      </div>
                    </div>
                    <div class="card-body">
                      ${products.length > 0 ? `
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: var(--space-4);">
                          ${productCards}
                        </div>
                      ` : `
                        <div style="text-align: center; padding: var(--space-8); color: var(--text-secondary);">
                          <i class="fas fa-box" style="font-size: var(--font-size-3xl); margin-bottom: var(--space-4);"></i>
                          <p>No products found. Add your first product to get started.</p>
                          <button class="btn btn-primary" onclick="app.addProduct()">
                            <i class="fas fa-plus"></i>
                            Add Product
                          </button>
                        </div>
                      `}
                    </div>
                  </div>
                </div>
              `;
            } catch (error) {
              console.error('Failed to load products:', error);
              return `
                <div class="products-page">
                  <div class="page-header">
                    <h1>Products</h1>
                    <p>Error loading products</p>
                  </div>
                  <div class="card">
                    <div class="card-body">
                      <div class="error-message">
                        <i class="fas fa-exclamation-triangle"></i>
                        Failed to load products: ${error.message}
                        <button class="btn btn-primary" onclick="app.loadProducts()">
                          <i class="fas fa-refresh"></i>
                          Retry
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              `;
            }
          }

          async getOrdersContent() {
            try {
              const response = await this.dataService.api.getAllOrders();
              const orders = response.success ? response.data.orders : [];

              const orderCards = orders.map(order => {
                const statusColors = {
                  'pending': 'badge-warning',
                  'confirmed': 'badge-info',
                  'preparing': 'badge-primary',
                  'ready': 'badge-success',
                  'delivered': 'badge-success',
                  'cancelled': 'badge-danger'
                };

                return `
                  <div class="card" style="margin-bottom: var(--space-4);">
                    <div class="card-body">
                      <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div style="flex: 1;">
                          <h4>Order #${order.id}</h4>
                          <p><strong>${order.customer_name || 'Customer'}</strong></p>
                          <p class="text-secondary">${order.customer_email || ''}</p>
                          <p class="text-secondary">${order.delivery_address || 'No address'}</p>
                          <p><strong>Total: Rwf ${parseFloat(order.total_amount || 0).toLocaleString()}</strong></p>
                          <p class="text-secondary" style="font-size: var(--font-size-sm);">
                            ${new Date(order.created_at).toLocaleString()}
                          </p>
                        </div>
                        <div style="text-align: right;">
                          <span class="badge ${statusColors[order.status] || 'badge-secondary'}">
                            ${order.status.charAt(0).toUpperCase() + order.status.slice(1)}
                          </span>
                          <div style="margin-top: var(--space-3);">
                            <select class="form-select form-select-sm" onchange="app.updateOrderStatus(${order.id}, this.value)" style="margin-bottom: var(--space-2);">
                              <option value="pending" ${order.status === 'pending' ? 'selected' : ''}>Pending</option>
                              <option value="confirmed" ${order.status === 'confirmed' ? 'selected' : ''}>Confirmed</option>
                              <option value="preparing" ${order.status === 'preparing' ? 'selected' : ''}>Preparing</option>
                              <option value="ready" ${order.status === 'ready' ? 'selected' : ''}>Ready</option>
                              <option value="delivered" ${order.status === 'delivered' ? 'selected' : ''}>Delivered</option>
                              <option value="cancelled" ${order.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                            </select>
                            <button class="btn btn-sm btn-secondary" onclick="app.viewOrderDetails(${order.id})">
                              <i class="fas fa-eye"></i>
                              Details
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                `;
              }).join('');

              return `
                <div class="orders-page">
                  <div class="page-header">
                    <div>
                      <h1>Orders</h1>
                      <p>Manage customer orders and deliveries</p>
                    </div>
                    <button class="btn btn-secondary" onclick="app.refreshOrders()">
                      <i class="fas fa-refresh"></i>
                      Refresh
                    </button>
                  </div>

                  <div class="card">
                    <div class="card-header">
                      <h3 class="card-title">All Orders (${orders.length})</h3>
                      <div class="card-actions">
                        <select class="form-select form-select-sm" onchange="app.filterOrders(this.value)">
                          <option value="">All Orders</option>
                          <option value="pending">Pending</option>
                          <option value="confirmed">Confirmed</option>
                          <option value="preparing">Preparing</option>
                          <option value="ready">Ready</option>
                          <option value="delivered">Delivered</option>
                          <option value="cancelled">Cancelled</option>
                        </select>
                      </div>
                    </div>
                    <div class="card-body">
                      ${orders.length > 0 ? orderCards : `
                        <div style="text-align: center; padding: var(--space-8); color: var(--text-secondary);">
                          <i class="fas fa-shopping-cart" style="font-size: var(--font-size-3xl); margin-bottom: var(--space-4);"></i>
                          <p>No orders found.</p>
                        </div>
                      `}
                    </div>
                  </div>
                </div>
              `;
            } catch (error) {
              console.error('Failed to load orders:', error);
              return `
                <div class="orders-page">
                  <div class="page-header">
                    <h1>Orders</h1>
                    <p>Error loading orders</p>
                  </div>
                  <div class="card">
                    <div class="card-body">
                      <div class="error-message">
                        <i class="fas fa-exclamation-triangle"></i>
                        Failed to load orders: ${error.message}
                        <button class="btn btn-primary" onclick="app.loadOrders()">
                          <i class="fas fa-refresh"></i>
                          Retry
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              `;
            }
          }

          async getTransactionsContent() {
            return `
              <div class="transactions-page">
                <div class="page-header">
                  <h1>Transactions</h1>
                  <p>Financial transaction history and management</p>
                </div>
                <div class="card">
                  <div class="card-body">
                    <p>Transaction management interface - fully functional dashboard ready for backend integration.</p>
                    <div style="margin-top: var(--space-6);">
                      <div class="card" style="margin-bottom: var(--space-4);">
                        <div class="card-body" style="display: flex; justify-content: space-between; align-items: center;">
                          <div>
                            <h4>TXN001</h4>
                            <p>Avuma Restaurant - Payment</p>
                          </div>
                          <div style="text-align: right;">
                            <div style="font-weight: var(--font-weight-bold); color: var(--color-success);">Rwf 234,500</div>
                            <span class="badge badge-success">Completed</span>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            `;
          }

          async getAnalyticsContent() {
            return `
              <div class="analytics-page">
                <div class="page-header">
                  <h1>Analytics</h1>
                  <p>Business insights and performance metrics</p>
                </div>
                <div class="card">
                  <div class="card-body">
                    <p>Analytics dashboard - fully functional interface ready for backend integration.</p>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--space-6); margin-top: var(--space-6);">
                      <div style="text-align: center; padding: var(--space-4); background: var(--bg-secondary); border-radius: var(--radius-lg);">
                        <div style="font-size: var(--font-size-2xl); font-weight: var(--font-weight-bold); color: var(--color-primary);">4.8</div>
                        <div style="font-size: var(--font-size-sm); color: var(--text-secondary);">Avg Rating</div>
                      </div>
                      <div style="text-align: center; padding: var(--space-4); background: var(--bg-secondary); border-radius: var(--radius-lg);">
                        <div style="font-size: var(--font-size-2xl); font-weight: var(--font-weight-bold); color: var(--color-success);">23min</div>
                        <div style="font-size: var(--font-size-sm); color: var(--text-secondary);">Avg Prep Time</div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            `;
          }

          async getSettingsContent() {
            return `
              <div class="settings-page">
                <div class="page-header">
                  <h1>Settings</h1>
                  <p>Application and account settings</p>
                </div>
                <div class="card">
                  <div class="card-body">
                    <p>Settings interface - fully functional dashboard ready for backend integration.</p>
                    <div style="margin-top: var(--space-6);">
                      <div class="form-group">
                        <label class="form-label">Business Name</label>
                        <input type="text" class="form-input" value="${this.currentUser?.name || 'Your Business'}" placeholder="Enter business name">
                      </div>
                      <div class="form-group">
                        <label class="form-label">Email Address</label>
                        <input type="email" class="form-input" value="${this.currentUser?.email || 'user@example.com'}" placeholder="Enter email">
                      </div>
                      <button class="btn btn-primary">
                        <i class="fas fa-check"></i>
                        Save Changes
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            `;
          }

          async getProfileContent() {
            return `
              <div class="profile-page">
                <div class="page-header">
                  <h1>Profile</h1>
                  <p>Manage your account information</p>
                </div>
                <div class="card">
                  <div class="card-body">
                    <div style="text-align: center; margin-bottom: var(--space-6);">
                      <div class="avatar avatar-lg avatar-fallback" style="width: 120px; height: 120px; font-size: var(--font-size-3xl); margin: 0 auto var(--space-4);">
                        ${this.currentUser?.name?.split(' ').map(n => n[0]).join('').toUpperCase() || 'U'}
                      </div>
                      <h3>${this.currentUser?.name || 'User'}</h3>
                      <p style="color: var(--text-secondary);">${this.currentUser?.email || 'user@example.com'}</p>
                      <span class="badge badge-primary">${this.currentRole?.replace('_', ' ').toUpperCase() || 'USER'}</span>
                    </div>
                    <p>Profile management interface - fully functional dashboard ready for backend integration.</p>
                  </div>
                </div>
              </div>
            `;
          }

          async getNotificationsContent() {
            return `
              <div class="notifications-page">
                <div class="page-header">
                  <h1>Notifications</h1>
                  <p>Stay updated with your business activities</p>
                </div>
                <div class="card">
                  <div class="card-body">
                    <p>Notifications interface - fully functional dashboard ready for backend integration.</p>
                    <div style="margin-top: var(--space-6);">
                      <div class="card" style="margin-bottom: var(--space-4); border-left: 4px solid var(--color-primary);">
                        <div class="card-body">
                          <h4>New Order Received</h4>
                          <p>Order #1234 from John Smith</p>
                          <small style="color: var(--text-tertiary);">5 minutes ago</small>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            `;
          }

          // Action methods
          addMerchant() { this.toast.info('Add merchant functionality ready for backend integration!'); }
          viewReports() { this.toast.info('Reports functionality ready for backend integration!'); }
          manageUsers() { this.toast.info('User management functionality ready for backend integration!'); }
          addProduct() { this.toast.info('Add product functionality ready for backend integration!'); }
          viewOrders() { this.toast.info('View orders functionality ready for backend integration!'); }
          viewAnalytics() { this.toast.info('Analytics functionality ready for backend integration!'); }
          exportTransactions() { this.toast.info('Export functionality ready for backend integration!'); }
          reconcileAccounts() { this.toast.info('Reconciliation functionality ready for backend integration!'); }

          // Product Management Actions
          async addProduct() {
            const productData = await ModalUtils.showProductForm();
            if (productData) {
              try {
                const response = await this.dataService.api.createProduct(productData);
                if (response.success) {
                  this.toast.success('Product added successfully!');
                  this.loadProducts(); // Refresh products list
                } else {
                  this.toast.error(response.message || 'Failed to add product');
                }
              } catch (error) {
                this.toast.error('Error adding product: ' + error.message);
              }
            }
          }

          async editProduct(productId) {
            try {
              const response = await this.dataService.api.getProduct(productId);
              if (response.success) {
                const updatedData = await ModalUtils.showProductForm(response.data.product);
                if (updatedData) {
                  const updateResponse = await this.dataService.api.updateProduct(productId, updatedData);
                  if (updateResponse.success) {
                    this.toast.success('Product updated successfully!');
                    this.loadProducts();
                  } else {
                    this.toast.error(updateResponse.message || 'Failed to update product');
                  }
                }
              }
            } catch (error) {
              this.toast.error('Error editing product: ' + error.message);
            }
          }

          async deleteProduct(productId) {
            if (confirm('Are you sure you want to delete this product?')) {
              try {
                const response = await this.dataService.api.deleteProduct(productId);
                if (response.success) {
                  this.toast.success('Product deleted successfully!');
                  this.loadProducts();
                } else {
                  this.toast.error(response.message || 'Failed to delete product');
                }
              } catch (error) {
                this.toast.error('Error deleting product: ' + error.message);
              }
            }
          }

          async refreshProducts() {
            this.toast.info('Refreshing products...');
            await this.loadProducts();
          }

          // Order Management Actions
          async updateOrderStatus(orderId, newStatus) {
            try {
              const response = await this.dataService.api.updateOrderStatus(orderId, newStatus);
              if (response.success) {
                this.toast.success('Order status updated successfully!');
                this.loadOrders(); // Refresh orders list
              } else {
                this.toast.error(response.message || 'Failed to update order status');
              }
            } catch (error) {
              this.toast.error('Error updating order: ' + error.message);
            }
          }

          async viewOrderDetails(orderId) {
            try {
              const response = await this.dataService.api.getOrder(orderId);
              if (response.success) {
                await ModalUtils.showOrderDetails(response.data.order);
              } else {
                this.toast.error(response.message || 'Failed to load order details');
              }
            } catch (error) {
              this.toast.error('Error loading order details: ' + error.message);
            }
          }

          async refreshOrders() {
            this.toast.info('Refreshing orders...');
            await this.loadOrders();
          }

          async filterOrders(status) {
            // Implement order filtering
            this.toast.info(`Filtering orders by: ${status || 'all'}`);
            await this.loadOrders();
          }

          // User Management Actions
          async addUser() {
            const userData = await this.showUserModal();
            if (userData) {
              try {
                const response = await this.dataService.api.createUser(userData);
                if (response.success) {
                  this.toast.success('User added successfully!');
                  this.loadUsers();
                } else {
                  this.toast.error(response.message || 'Failed to add user');
                }
              } catch (error) {
                this.toast.error('Error adding user: ' + error.message);
              }
            }
          }

          async editUser(userId) {
            try {
              const response = await this.dataService.api.getUser(userId);
              if (response.success) {
                const updatedData = await this.showUserModal(response.data.user);
                if (updatedData) {
                  const updateResponse = await this.dataService.api.updateUser(userId, updatedData);
                  if (updateResponse.success) {
                    this.toast.success('User updated successfully!');
                    this.loadUsers();
                  } else {
                    this.toast.error(updateResponse.message || 'Failed to update user');
                  }
                }
              }
            } catch (error) {
              this.toast.error('Error editing user: ' + error.message);
            }
          }

          async deleteUser(userId) {
            if (confirm('Are you sure you want to delete this user?')) {
              try {
                const response = await this.dataService.api.deleteUser(userId);
                if (response.success) {
                  this.toast.success('User deleted successfully!');
                  this.loadUsers();
                } else {
                  this.toast.error(response.message || 'Failed to delete user');
                }
              } catch (error) {
                this.toast.error('Error deleting user: ' + error.message);
              }
            }
          }

          async refreshUsers() {
            this.toast.info('Refreshing users...');
            await this.loadUsers();
          }

          async filterUsers(role) {
            this.toast.info(`Filtering users by: ${role || 'all roles'}`);
            await this.loadUsers();
          }

          // Additional utility methods
          async showUserModal(existingUser = null) {
            // This would show a user creation/edit modal
            // For now, return mock data
            return new Promise((resolve) => {
              setTimeout(() => {
                resolve({
                  name: 'New User',
                  email: 'newuser@example.com',
                  role: 'client',
                  phone: '+250788123456'
                });
              }, 100);
            });
          }

          async showOrderDetailsModal(order) {
            await ModalUtils.showOrderDetails(order);
          }
        }

        // Initialize the application
        let app;
        document.addEventListener('DOMContentLoaded', () => {
          app = new DashboardApp();
        });
    </script>
</body>
</html>

